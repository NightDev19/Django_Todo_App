{% extends 'base.html' %}
{% block title %}Todos - Django App{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 800px;">
    <h1 class="text-center mb-4">Todo List</h1>

    <!-- ADD TODO -->
    <form method="POST" action="{% url 'add_todo' %}" enctype="multipart/form-data" class="mb-4">
        {% csrf_token %}
        <div class="input-group mb-2">
            <input type="text" name="title" class="form-control" placeholder="Add new todo" required>
        </div>
        <div class="input-group">
            <input type="file" name="image" class="form-control" accept="image/*">
            <div class="input-group-append">
                <button type="submit" class="btn btn-primary">Add</button>
            </div>
        </div>
    </form>

    <!-- TODO LIST -->
    <ul class="list-group mb-4">
        {% for todo in todos %}
        <li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center">
                    {% if todo.image %}
                    <div class="mr-3">
                        <img src="{{ todo.image.url }}" alt="{{ todo.title }}" style="max-width: 80px; max-height: 80px; border-radius: 5px; cursor: pointer; object-fit: cover;" onclick="openImageModal('{{ todo.image.url }}', '{{ todo.title }}')">
                    </div>
                    {% endif %}
                    <div>
                        {% if todo.completed %}
                        <del class="text-muted">{{ todo.title }}</del>
                        {% else %}
                        <span>{{ todo.title }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="d-flex ml-2" style="gap: 5px;">
                {% if todo.completed %}
                <form method="POST" action="{% url 'uncomplete_todo' todo.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary" title="Mark as incomplete">↺</button>
                </form>
                {% else %}
                <form method="POST" action="{% url 'complete_todo' todo.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-success" title="Mark as complete">✓</button>
                </form>
                {% endif %}

                <button type="button" class="btn btn-sm btn-outline-warning" data-toggle="modal" 
                        data-target="#editModal{{ todo.id }}" title="Edit">✎</button>

                <form method="POST" action="{% url 'delete_todo' todo.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" title="Delete">✕</button>
                </form>
            </div>
        </li>

        <!-- EDIT MODAL -->
        <div class="modal fade" id="editModal{{ todo.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form method="POST" action="{% url 'edit_todo' todo.id %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Todo</h5>
                            <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" name="title" class="form-control mb-3" value="{{ todo.title }}" required>
                            {% if todo.image %}
                            <div class="mb-2">
                                <img src="{{ todo.image.url }}" alt="{{ todo.title }}" style="max-width: 100%; max-height: 200px; border-radius: 5px; cursor: pointer;" onclick="openImageModal('{{ todo.image.url }}', '{{ todo.title }}')">
                            </div>
                            {% endif %}
                            <input type="file" name="image" class="form-control" accept="image/*">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% empty %}
        <li class="list-group-item text-center text-muted">No todos yet. Add one above!</li>
        {% endfor %}
    </ul>

    <!-- CLEAR COMPLETED -->
    <div class="text-center mb-4">
        <form method="POST" action="{% url 'clear_completed' %}">
            {% csrf_token %}
            <button class="btn btn-outline-danger">Clear Completed Todos</button>
        </form>
    </div>

<!-- PAGINATION -->
{% if todos.has_other_pages %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">

        <!-- Previous -->
        {% if todos.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ todos.previous_page_number }}">&lt;</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&lt;</span>
        </li>
        {% endif %}

        <!-- First page -->
        <li class="page-item {% if todos.number == 1 %}active{% endif %}">
            <a class="page-link" href="?page=1">1</a>
        </li>

        <!-- Leading ellipsis -->
        {% if todos.number > 2 %}
        <li class="page-item disabled">
            <span class="page-link">…</span>
        </li>
        {% endif %}

        <!-- Current page (only if not first or last) -->
        {% if todos.number != 1 and todos.number != todos.paginator.num_pages %}
        <li class="page-item active">
            <span class="page-link">{{ todos.number }}</span>
        </li>
        {% endif %}

        <!-- Trailing ellipsis -->
        {% if todos.number < todos.paginator.num_pages|add:'-1' %}
        <li class="page-item disabled">
            <span class="page-link">…</span>
        </li>
        {% endif %}

        <!-- Last page -->
        {% if todos.paginator.num_pages > 1 %}
        <li class="page-item {% if todos.number == todos.paginator.num_pages %}active{% endif %}">
            <a class="page-link" href="?page={{ todos.paginator.num_pages }}">
                {{ todos.paginator.num_pages }}
            </a>
        </li>
        {% endif %}

        <!-- Next -->
        {% if todos.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ todos.next_page_number }}">&gt;</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&gt;</span>
        </li>
        {% endif %}

    </ul>
</nav>
{% endif %}


</div>

<!-- IMAGE PREVIEW MODAL -->
<div id="imagePreviewModal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); cursor: pointer;" onclick="closeImageModal()">
    <span style="position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;" onclick="closeImageModal()">&times;</span>
    <img id="previewImage" style="margin: auto; display: block; max-width: 90%; max-height: 90%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
</div>

<script>
function openImageModal(imageUrl, altText) {
    document.getElementById('imagePreviewModal').style.display = 'block';
    document.getElementById('previewImage').src = imageUrl;
    document.getElementById('previewImage').alt = altText;
}

function closeImageModal() {
    document.getElementById('imagePreviewModal').style.display = 'none';
}
</script>
{% endblock %}